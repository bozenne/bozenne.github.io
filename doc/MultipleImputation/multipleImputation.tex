% Created 2020-10-12 ma 15:58
% Intended LaTeX compiler: pdflatex
\documentclass[12pt]{article}

%%%% settings when exporting code %%%% 

\usepackage{listings}
\lstset{
backgroundcolor=\color{white},
basewidth={0.5em,0.4em},
basicstyle=\ttfamily\small,
breakatwhitespace=false,
breaklines=true,
columns=fullflexible,
commentstyle=\color[rgb]{0.5,0,0.5},
frame=single,
keepspaces=true,
keywordstyle=\color{black},
literate={~}{$\sim$}{1},
numbers=left,
numbersep=10pt,
numberstyle=\ttfamily\tiny\color{gray},
showspaces=false,
showstringspaces=false,
stepnumber=1,
stringstyle=\color[rgb]{0,.5,0},
tabsize=4,
xleftmargin=.23in,
emph={anova,apply,class,coef,colnames,colNames,colSums,dim,dcast,for,ggplot,head,if,ifelse,is.na,lapply,list.files,library,logLik,melt,plot,require,rowSums,sapply,setcolorder,setkey,str,summary,tapply},
emphstyle=\color{blue}
}

%%%% packages %%%%%

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{textcomp}
\usepackage{color}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{grffile}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage{longtable}
\usepackage{multirow}
\usepackage{multicol}
\usepackage{changes}
\usepackage{pdflscape}
\usepackage{geometry}
\usepackage[normalem]{ulem}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{dsfont}
\usepackage{array}
\usepackage{ifthen}
\usepackage{hyperref}
\usepackage{natbib}
%
%%%% specifications %%%%
%
\usepackage{ifthen}
\usepackage{xifthen}
\usepackage{xargs}
\usepackage{xspace}
\newcommand\Rlogo{\textbf{\textsf{R}}\xspace} %
\RequirePackage{fancyvrb}
\DefineVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\small,formatcom = {\color[rgb]{0.5,0,0}}}
\RequirePackage{colortbl} % arrayrulecolor to mix colors
\RequirePackage{setspace} % to modify the space between lines - incompatible with footnote in beamer
\renewcommand{\baselinestretch}{1.1}
\geometry{top=1cm}
\RequirePackage{epstopdf} % to be able to convert .eps to .pdf image files
\RequirePackage{capt-of} %
\RequirePackage{caption} % newlines in graphics
\RequirePackage{amsmath}
\RequirePackage{algorithm}
\RequirePackage[noend]{algpseudocode}
\RequirePackage{dsfont}
\RequirePackage{amsmath,stmaryrd,graphicx}
\RequirePackage{prodint} % product integral symbol (\PRODI)
\newcommand\defOperator[7]{%
\ifthenelse{\isempty{#2}}{
\ifthenelse{\isempty{#1}}{#7{#3}#4}{#7{#3}#4 \left#5 #1 \right#6}
}{
\ifthenelse{\isempty{#1}}{#7{#3}#4_{#2}}{#7{#3}#4_{#1}\left#5 #2 \right#6}
}
}
\newcommand\defUOperator[5]{%
\ifthenelse{\isempty{#1}}{
#5\left#3 #2 \right#4
}{
\ifthenelse{\isempty{#2}}{\underset{#1}{\operatornamewithlimits{#5}}}{
\underset{#1}{\operatornamewithlimits{#5}}\left#3 #2 \right#4}
}
}
\newcommand{\defBoldVar}[2]{
\ifthenelse{\equal{#2}{T}}{\boldsymbol{#1}}{\mathbf{#1}}
}
\newcommandx\Cov[2][1=,2=]{\defOperator{#1}{#2}{C}{ov}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Esp[2][1=,2=]{\defOperator{#1}{#2}{E}{}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Prob[2][1=,2=]{\defOperator{#1}{#2}{P}{}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Qrob[2][1=,2=]{\defOperator{#1}{#2}{Q}{}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Var[2][1=,2=]{\defOperator{#1}{#2}{V}{ar}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Binom[2][1=,2=]{\defOperator{#1}{#2}{B}{}{(}{)}{\mathcal}}
\newcommandx\Gaus[2][1=,2=]{\defOperator{#1}{#2}{N}{}{(}{)}{\mathcal}}
\newcommandx\Wishart[2][1=,2=]{\defOperator{#1}{#2}{W}{ishart}{(}{)}{\mathcal}}
\newcommandx\Likelihood[2][1=,2=]{\defOperator{#1}{#2}{L}{}{(}{)}{\mathcal}}
\newcommandx\Information[2][1=,2=]{\defOperator{#1}{#2}{I}{}{(}{)}{\mathcal}}
\newcommandx\Score[2][1=,2=]{\defOperator{#1}{#2}{S}{}{(}{)}{\mathcal}}
\newcommandx\Vois[2][1=,2=]{\defOperator{#1}{#2}{V}{}{(}{)}{\mathcal}}
\newcommandx\IF[2][1=,2=]{\defOperator{#1}{#2}{IF}{}{(}{)}{\mathcal}}
\newcommandx\Ind[1][1=]{\defOperator{}{#1}{1}{}{(}{)}{\mathds}}
\newcommandx\Max[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{min}}
\newcommandx\Min[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{max}}
\newcommandx\argMax[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{argmax}}
\newcommandx\argMin[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{argmin}}
\newcommandx\cvD[2][1=D,2=n \rightarrow \infty]{\xrightarrow[#2]{#1}}
\newcommandx\Hypothesis[2][1=,2=]{
\ifthenelse{\isempty{#1}}{
\mathcal{H}
}{
\ifthenelse{\isempty{#2}}{
\mathcal{H}_{#1}
}{
\mathcal{H}^{(#2)}_{#1}
}
}
}
\newcommandx\dpartial[4][1=,2=,3=,4=\partial]{
\ifthenelse{\isempty{#3}}{
\frac{#4 #1}{#4 #2}
}{
\left.\frac{#4 #1}{#4 #2}\right\rvert_{#3}
}
}
\newcommandx\dTpartial[3][1=,2=,3=]{\dpartial[#1][#2][#3][d]}
\newcommandx\ddpartial[3][1=,2=,3=]{
\ifthenelse{\isempty{#3}}{
\frac{\partial^{2} #1}{\left( \partial #2\right)^2}
}{
\frac{\partial^2 #1}{\partial #2\partial #3}
}
}
\newcommand\Real{\mathbb{R}}
\newcommand\Rational{\mathbb{Q}}
\newcommand\Natural{\mathbb{N}}
\newcommand\trans[1]{{#1}^\intercal}%\newcommand\trans[1]{{\vphantom{#1}}^\top{#1}}
\newcommand{\independent}{\mathrel{\text{\scalebox{1.5}{$\perp\mkern-10mu\perp$}}}}
\newcommand\half{\frac{1}{2}}
\newcommand\normMax[1]{\left|\left|#1\right|\right|_{max}}
\newcommand\normTwo[1]{\left|\left|#1\right|\right|_{2}}
\author{Brice Ozenne}
\date{\today}
\title{A simple example of multiple imputation using the mice package}
\hypersetup{
 colorlinks=true,
 citecolor=[rgb]{0,0.5,0},
 urlcolor=[rgb]{0,0,0.5},
 linkcolor=[rgb]{0,0,0.5},
 pdfauthor={Brice Ozenne},
 pdftitle={A simple example of multiple imputation using the mice package},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={Emacs 25.2.1 (Org mode 9.0.4)},
 pdflang={English}
 }
\begin{document}

\maketitle
This document gathers code from the documentation of the mice
package. See \url{https://stefvanbuuren.name/mice/}.

\bigskip

Load packages
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
library(lava)
library(mice)
library(data.table)
library(ggplot2)
\end{lstlisting}

\section{Simulate data (just to have an example to work with)}
\label{sec:org9251918}
Generative model
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
mSim <- lvm(Y~group+season+bmi+gender+age)
categorical(mSim, labels = c("winter","summer")) <- ~season
categorical(mSim, labels = c("SAD","HC")) <- ~group
categorical(mSim, labels = c("Male","Female")) <- ~gender
distribution(mSim,~bmi) <- lava::gaussian.lvm(mean = 22, sd = 3)
distribution(mSim,~age) <- lava::uniform.lvm(20,80)
\end{lstlisting}

Sampling
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
n <- 1e2
set.seed(10)
dt.data <- as.data.table(sim(mSim,n))
\end{lstlisting}

Add missing values
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
dt.data[1:10, bmi:=NA]
\end{lstlisting}

\clearpage

\section{Working with mice}
\label{sec:orgd7338b3}

\subsection{Step 1: Inspect the missing data pattern}
\label{sec:org2ab9bff}
Check the number of missing values in the dataset:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
colSums(is.na(dt.data))
\end{lstlisting}

\begin{verbatim}
Y  group season    bmi gender    age 
0      0      0     10      0      0
\end{verbatim}

Missing data patterns:   
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
md.pattern(dt.data)
\end{lstlisting}

\begin{verbatim}
   Y group season gender age bmi   
90 1     1      1      1   1   1  0
10 1     1      1      1   1   0  1
   0     0      0      0   0  10 10
\end{verbatim}

\begin{center}
\includegraphics[width=.9\linewidth]{./missingDataPattern.pdf}
\end{center}

Note: with more patterns it becomes clear that the left column counts
the number of observations with a specific patern. The right column
display the index of the pattern. The bottom row counts the number of
missing value relative to each variable (and the total number of
missing values).
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
dt.data2 <- copy(dt.data)
dt.data2[5:10,age:=NA]
md.pattern(dt.data2)
\end{lstlisting}

\begin{verbatim}
   Y group season gender age bmi   
90 1     1      1      1   1   1  0
4  1     1      1      1   1   0  1
6  1     1      1      1   0   0  2
   0     0      0      0   6  10 16
\end{verbatim}

\clearpage

\subsection{Step 2: Define imputation model}
\label{sec:org7423ff7}

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
all.variables <- c("Y","group","season","bmi","gender","age")
n.variables <- length(all.variables)
Mlink <- matrix(0, n.variables, n.variables,
				dimnames = list(all.variables,all.variables))
Mlink["bmi",c("group","season","gender","age")] <- 1
Mlink
\end{lstlisting}

\begin{verbatim}
       Y group season bmi gender age
Y      0     0      0   0      0   0
group  0     0      0   0      0   0
season 0     0      0   0      0   0
bmi    0     1      1   0      1   1
gender 0     0      0   0      0   0
age    0     0      0   0      0   0
\end{verbatim}

A value of 1 means that the column variable is used as a predictor for
 the target block (in the rows).

\clearpage

\subsection{Step 3: Generate imputed datasets}
\label{sec:org462158b}
Generate imputed values
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
n.imputed <- 3 ## number of imputed datasets
dt.mice <- mice(dt.data,
				m=n.imputed, 
				maxit = 50, # number of iterations to obtain the imputed dataset
				predictorMatrix = Mlink,
				method = 'pmm', # Predictive mean matching, only ok for continuous variables, it is possible to set constrains for positive variables
				seed = 500, printFlag = FALSE)
summary(dt.mice)
\end{lstlisting}

\begin{verbatim}
Class: mids
Number of multiple imputations:  3 
Imputation methods:
     Y  group season    bmi gender    age 
    ""     ""     ""  "pmm"     ""     "" 
PredictorMatrix:
       Y group season bmi gender age
Y      0     0      0   0      0   0
group  0     0      0   0      0   0
season 0     0      0   0      0   0
bmi    0     1      1   0      1   1
gender 0     0      0   0      0   0
age    0     0      0   0      0   0
\end{verbatim}

\subsubsection{Interacting with the mice object}
\label{sec:orge3bf48c}

Missingness indicator:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
table(cci(dt.mice))
\end{lstlisting}

\begin{verbatim}

FALSE  TRUE 
   10    90
\end{verbatim}


Complete case dataset:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
str(cc(dt.mice))
\end{lstlisting}

\begin{verbatim}
'data.frame':	90 obs. of  6 variables:
 $ Y     : num  102 82.9 94.9 61.4 82 ...
 $ group : Factor w/ 2 levels "SAD","HC": 1 2 1 1 2 2 2 2 2 2 ...
 $ season: Factor w/ 2 levels "winter","summer": 2 2 1 1 2 1 2 1 1 1 ...
 $ bmi   : num  21.6 21.9 20.6 26.4 28.5 ...
 $ gender: Factor w/ 2 levels "Male","Female": 2 2 2 1 1 2 2 1 2 2 ...
 $ age   : num  77.3 57.2 73.6 34 50.7 ...
\end{verbatim}

Extract observations with missing values:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
str(ic(dt.mice))
\end{lstlisting}

\begin{verbatim}
'data.frame':	10 obs. of  6 variables:
 $ Y     : num  92.2 91 63.1 76.2 75.2 ...
 $ group : Factor w/ 2 levels "SAD","HC": 1 2 1 2 1 2 2 1 2 2
 $ season: Factor w/ 2 levels "winter","summer": 2 2 2 2 1 2 2 1 1 1
 $ bmi   : num  NA NA NA NA NA NA NA NA NA NA
 $ gender: Factor w/ 2 levels "Male","Female": 2 2 1 2 2 2 1 2 1 1
 $ age   : num  68.5 62.6 34.9 50.6 54.1 ...
\end{verbatim}

Dataset after multiple imputation:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
str(complete(dt.mice, action = 1)) ## first imputed dataset
\end{lstlisting}

\begin{verbatim}
'data.frame':	100 obs. of  6 variables:
 $ Y     : num  92.2 91 63.1 76.2 75.2 ...
 $ group : Factor w/ 2 levels "SAD","HC": 1 2 1 2 1 2 2 1 2 2 ...
 $ season: Factor w/ 2 levels "winter","summer": 2 2 2 2 1 2 2 1 1 1 ...
 $ bmi   : num  25.9 21 16.7 20.2 25.9 ...
 $ gender: Factor w/ 2 levels "Male","Female": 2 2 1 2 2 2 1 2 1 1 ...
 $ age   : num  68.5 62.6 34.9 50.6 54.1 ...
\end{verbatim}

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
str(complete(dt.mice, action = 2)) ## second imputed dataset
\end{lstlisting}

\begin{verbatim}
'data.frame':	100 obs. of  6 variables:
 $ Y     : num  92.2 91 63.1 76.2 75.2 ...
 $ group : Factor w/ 2 levels "SAD","HC": 1 2 1 2 1 2 2 1 2 2 ...
 $ season: Factor w/ 2 levels "winter","summer": 2 2 2 2 1 2 2 1 1 1 ...
 $ bmi   : num  17.5 18.1 24.3 20.7 20.9 ...
 $ gender: Factor w/ 2 levels "Male","Female": 2 2 1 2 2 2 1 2 1 1 ...
 $ age   : num  68.5 62.6 34.9 50.6 54.1 ...
\end{verbatim}

\clearpage

\subsection{Step 4: Check the imputed datasets}
\label{sec:orga55e89b}
\subsubsection{Convergence of the imputation algorithm}
\label{sec:orgbae9b3f}

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
plot(dt.mice)
\end{lstlisting}

\begin{center}
\includegraphics[width=.9\linewidth]{./traceCVimputed.pdf}
\end{center}


\subsubsection{Visualizing the imputed values}
\label{sec:orgd7efc99}
Visualize imputed value values and check they are plausible (e.g. mice
is not imputed a BMI of 75):
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
dt.mice$imp$bmi
\end{lstlisting}

\begin{verbatim}
          1        2        3
1  25.86170 17.51962 26.03528
2  20.97076 18.12224 21.60139
3  16.68404 24.25679 17.86661
4  20.15124 20.71567 26.03528
5  25.86170 20.92015 25.24236
6  24.80171 25.02219 20.62111
7  21.42336 25.02219 25.02219
8  21.00639 20.90548 20.15124
9  24.76365 12.99571 24.80171
10 15.52519 12.99571 21.42336
\end{verbatim}

The rows correspond to the 3 different imputed datasets and the
columns to 10 imputed values per dataset. One can also summarizes the
imputed values computing their quantiles:

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
apply(dt.mice$imp$bmi,2,quantile)
\end{lstlisting}

\begin{verbatim}
            1        2        3
0%   15.52519 12.99571 17.86661
25%  20.35612 17.67028 20.82167
50%  21.21487 20.81058 23.20155
75%  24.79219 23.42263 25.18731
100% 25.86170 25.02219 26.03528
\end{verbatim}

Boxplot of the imputed values:

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
boxplot(dt.mice$imp$bmi)
\end{lstlisting}

\begin{center}
\includegraphics[width=.9\linewidth]{./boxplotImputed.pdf}
\end{center}

Imputed values vs. observed values
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
dt.bmi <- rbind(data.table(bmi = unlist(dt.mice$imp$bmi), imputed = TRUE),
				data.table(bmi = na.omit(dt.data$bmi), imputed = FALSE))
\end{lstlisting}

Histogram
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
gg1.bmi <- ggplot(dt.bmi, aes(bmi, group = imputed, fill = imputed))
gg1.bmi <- gg1.bmi + geom_histogram(aes(y=..count../sum(..count..)),position = "dodge")
gg1.bmi
\end{lstlisting}

\begin{verbatim}
`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
\end{verbatim}

\begin{center}
\includegraphics[width=.9\linewidth]{./histImputed.pdf}
\end{center}

One more plot:

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
stripplot(dt.mice, bmi~.imp, pch=20, cex=2)
\end{lstlisting}

\begin{center}
\includegraphics[width=.9\linewidth]{./striplotImputed.pdf}
\end{center}

\clearpage

\subsection{Step 3: Fit the statical model on each imputed dataset}
\label{sec:org254833b}

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
e.mice <- with(data = dt.mice,
			   lm(Y~group+season+bmi+gender+age)
			   )
e.mice
\end{lstlisting}

\begin{verbatim}
call :
with.mids(data = dt.mice, expr = lm(Y ~ group + season + bmi + 
    gender + age))

call1 :
mice(data = dt.data, m = n.imputed, method = "pmm", predictorMatrix = Mlink, 
    maxit = 50, printFlag = FALSE, seed = 500)

nmis :
     Y  group season    bmi gender    age 
     0      0      0     10      0      0 

analyses :
[[1]]

Call:
lm(formula = Y ~ group + season + bmi + gender + age)

Coefficients:
 (Intercept)       groupHC  seasonsummer           bmi  genderFemale           age  
      2.8846        0.7238        1.2174        0.8602        0.5507        1.0058  


[[2]]

Call:
lm(formula = Y ~ group + season + bmi + gender + age)

Coefficients:
 (Intercept)       groupHC  seasonsummer           bmi  genderFemale           age  
      3.8365        0.6732        0.8917        0.7907        0.7422        1.0221  


[[3]]

Call:
lm(formula = Y ~ group + season + bmi + gender + age)

Coefficients:
 (Intercept)       groupHC  seasonsummer           bmi  genderFemale           age  
      2.2639        0.5601        1.1779        0.8919        0.7209        1.0025
\end{verbatim}

Check that using \texttt{with}:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
e.mice$analyses[[1]]
\end{lstlisting}

\begin{verbatim}

Call:
lm(formula = Y ~ group + season + bmi + gender + age)

Coefficients:
 (Intercept)       groupHC  seasonsummer           bmi  genderFemale           age  
      2.8846        0.7238        1.2174        0.8602        0.5507        1.0058
\end{verbatim}

is equivalent to run the linear regression on the imputed dataset:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
dt.tempo <- copy(dt.data)
dt.tempo[is.na(bmi), bmi := dt.mice$imp$bmi[,1]]
lm(Y ~ group + season + bmi + gender + age, data  = dt.tempo)
\end{lstlisting}

\begin{verbatim}

Call:
lm(formula = Y ~ group + season + bmi + gender + age, data = dt.tempo)

Coefficients:
 (Intercept)       groupHC  seasonsummer           bmi  genderFemale           age  
      2.8846        0.7238        1.2174        0.8602        0.5507        1.0058
\end{verbatim}

\clearpage

\subsection{Step 4: Pool the results over the imputed datasets}
\label{sec:org8fdcc02}

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
ePool.mice <- pool(e.mice)
summary(ePool.mice)
\end{lstlisting}

\begin{verbatim}
          term  estimate  std.error statistic        df      p.value
1  (Intercept) 2.9949755 1.73919838  1.722044 18.777429 1.014936e-01
2      groupHC 0.6523698 0.42434760  1.537348 78.067966 1.282516e-01
3 seasonsummer 1.0956572 0.46036133  2.379994 30.027026 2.386256e-02
4          bmi 0.8475895 0.08552179  9.910802  7.101823 2.060982e-05
5 genderFemale 0.6712684 0.42707145  1.571794 66.444876 1.207484e-01
6          age 1.0101585 0.01664369 60.693193  6.176972 8.221885e-10
\end{verbatim}


The (pooled) estimate is the average of the estimates relative to each
imputed dataset:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
Q.coef <- colMeans(do.call(rbind,lapply(e.mice$analyses, coef)))
Q.coef
\end{lstlisting}

\begin{verbatim}
(Intercept)      groupHC seasonsummer          bmi genderFemale          age 
  2.9949755    0.6523698    1.0956572    0.8475895    0.6712684    1.0101585
\end{verbatim}

The variance is a bit more complex and involves:
\begin{itemize}
\item the within-imputation variance (depends on the sample size)
\end{itemize}
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
covW <- Reduce("+",lapply(e.mice$analyses, vcov))/n.imputed
covW
\end{lstlisting}

\begin{verbatim}
              (Intercept)      groupHC  seasonsummer           bmi  genderFemale           age
(Intercept)   2.188289907 -0.130400039 -0.0484223022 -7.927754e-02 -0.1095235936 -5.258801e-03
groupHC      -0.130400039  0.170709255  0.0136109053  3.016196e-03  0.0065597118 -6.690650e-04
seasonsummer -0.048422302  0.013610905  0.1698149812 -2.313649e-03  0.0155962276 -2.010675e-04
bmi          -0.079277538  0.003016196 -0.0023136489  3.737559e-03 -0.0004297325 -4.654701e-05
genderFemale -0.109523594  0.006559712  0.0155962276 -4.297325e-04  0.1677140389  2.941101e-04
age          -0.005258801 -0.000669065 -0.0002010675 -4.654701e-05  0.0002941101  1.309967e-04
\end{verbatim}

\begin{itemize}
\item the between-imputation variance (depends on the amount of missing data)
\end{itemize}
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
ls.diffCoef <- lapply(e.mice$analyses, function(iI){coef(iI)-Q.coef})
covB <- Reduce("+",lapply(ls.diffCoef,tcrossprod))/(n.imputed-1)
covB
\end{lstlisting}

\begin{verbatim}
             [,1]          [,2]         [,3]          [,4]          [,5]          [,6]
[1,]  0.627390824  0.0385432571 -0.122593995 -0.0408508793  0.0183325405  0.0080428980
[2,]  0.038543257  0.0070212239 -0.001571700 -0.0021866596 -0.0058542019  0.0003214691
[3,] -0.122593995 -0.0015716997  0.031588177  0.0083960389 -0.0125224208 -0.0017927139
[4,] -0.040850879 -0.0021866596  0.008396039  0.0026823137 -0.0016781764 -0.0005356745
[5,]  0.018332541 -0.0058542019 -0.012522421 -0.0016781764  0.0110069866  0.0004939914
[6,]  0.008042898  0.0003214691 -0.001792714 -0.0005356745  0.0004939914  0.0001095117
\end{verbatim}

\begin{itemize}
\item the simulation error
\end{itemize}
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
covE <- covB/n.imputed
covE
\end{lstlisting}

\begin{verbatim}
             [,1]          [,2]          [,3]          [,4]          [,5]          [,6]
[1,]  0.209130275  0.0128477524 -0.0408646652 -0.0136169598  0.0061108468  2.680966e-03
[2,]  0.012847752  0.0023404080 -0.0005238999 -0.0007288865 -0.0019514006  1.071564e-04
[3,] -0.040864665 -0.0005238999  0.0105293924  0.0027986796 -0.0041741403 -5.975713e-04
[4,] -0.013616960 -0.0007288865  0.0027986796  0.0008941046 -0.0005593921 -1.785582e-04
[5,]  0.006110847 -0.0019514006 -0.0041741403 -0.0005593921  0.0036689955  1.646638e-04
[6,]  0.002680966  0.0001071564 -0.0005975713 -0.0001785582  0.0001646638  3.650389e-05
\end{verbatim}

The total variance is:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
covT <- covW + covB + covE
\end{lstlisting}

leading to the standard errors:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
sqrt(diag(covT))
\end{lstlisting}
\begin{verbatim}
(Intercept)      groupHC seasonsummer          bmi genderFemale          age 
 1.73919838   0.42434760   0.46036133   0.08552179   0.42707145   0.01664369
\end{verbatim}


\bigskip

There is also a function to extract the R-squared:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
pool.r.squared(e.mice)
\end{lstlisting}

\begin{verbatim}
          est     lo 95     hi 95 fmi
R^2 0.9890535 0.9819615 0.9933666 NaN
\end{verbatim}

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
vec.rsquared <- sapply(e.mice$analyses, function(iImp){
	summary(iImp)$r.squared
})
tanh(mean(atanh(vec.rsquared)))
\end{lstlisting}

\begin{verbatim}
[1] 0.9890535
\end{verbatim}

\clearpage

\section{Special case: imputation using a specific law and no covariate}
\label{sec:orge0d65eb}
Mice can be adapted in order, for instance, to sample from a uniform
distribution or a truncated normal distribution. First define a
function able to generate data like:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
mice.impute.SI_unif <- function(y, ry, ...){ ## uniform law
	n.NA <- sum(ry==FALSE)
	sample <- runif(n.NA, min = 0, max = 1)
	return(cbind(sample))
}
\end{lstlisting}

or

\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
mice.impute.SI_tnorm <- function(y, ry, ...){ ## truncated normal law
	require(truncnorm)
	n.NA <- sum(ry==FALSE)
	sample <- rtruncnorm(n.NA, a = 0, b = 1, mean = 1, sd = 0.1)
	return(cbind(sample))
}
\end{lstlisting}
Then prepare the matrix indicating which variable should be used
during the imputation:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
impute.var <- c("bmi","group")
Mlink2 <- matrix(0, 
				 nrow = length(impute.var), 
				 ncol = length(impute.var), 
				 dimnames = list(impute.var,impute.var))
Mlink2["bmi","group"] <- 1
Mlink2
\end{lstlisting}

\begin{verbatim}
      bmi group
bmi     0     1
group   0     0
\end{verbatim}

\clearpage 

Then run mice as usual except that the method should correspond to one of the previous functions:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
n.imputed <- 50 ## number of imputed datasets
set.seed(1)
dt.mice2 <- mice(dt.data,
				 m=n.imputed, 
				 maxit = 1, # not relevant
				 predictorMatrix = Mlink2, # not relevant
				 method = 'SI_tnorm', # function previous define (without "mice.impute.")
				 seed = 500, printFlag = FALSE)
\end{lstlisting}

Then as usual one should check that the imputed values are satisfying:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
quantile(unlist(dt.mice2$imp$bmi))
\end{lstlisting}

\begin{verbatim}
       0%       25%       50%       75%      100% 
0.7041556 0.8790477 0.9317021 0.9687630 0.9997288
\end{verbatim}


\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
hist(unlist(dt.mice2$imp$bmi))
\end{lstlisting}

\begin{center}
\includegraphics[width=.9\linewidth]{./histImputed2.pdf}
\end{center}

\clearpage

One more plot:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
stripplot(dt.mice2, bmi~.imp, pch=20, cex=2)
\end{lstlisting}

\begin{center}
\includegraphics[width=.9\linewidth]{./striplotImputed2.pdf}
\end{center}

Here for instance the imputed values does not overlap the observed one
so something (i.e. the parameters of the distribution used for the
imputation) is wrong.

\section{Reporting guideline}
\label{sec:org3135883}
From \url{https://stefvanbuuren.name/Winnipeg/Lectures/Winnipeg.pdf}:
\begin{itemize}
\item Amount of missing data
\item Reasons for missingness
\item Differences between complete and incomplete data
\item Method used to account for missing data
\item Software
\item Number of imputed datasets
\item Imputation model
\item Derived variables
\item Diagnostics
\item Pooling
\item Listwise deletion
\item Sensitivity analysis
\end{itemize}
\end{document}