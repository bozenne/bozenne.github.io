% Created 2021-03-08 man 17:43
% Intended LaTeX compiler: pdflatex
\documentclass[12pt]{article}

%%%% settings when exporting code %%%% 

\usepackage{listings}
\lstdefinestyle{code-small}{
backgroundcolor=\color{white}, % background color for the code block
basicstyle=\ttfamily\small, % font used to display the code
commentstyle=\color[rgb]{0.5,0,0.5}, % color used to display comments in the code
keywordstyle=\color{black}, % color used to highlight certain words in the code
numberstyle=\ttfamily\tiny\color{gray}, % color used to display the line numbers
rulecolor=\color{black}, % color of the frame
stringstyle=\color[rgb]{0,.5,0},  % color used to display strings in the code
breakatwhitespace=false, % sets if automatic breaks should only happen at whitespace
breaklines=true, % sets automatic line breaking
columns=fullflexible,
frame=single, % adds a frame around the code (non,leftline,topline,bottomline,lines,single,shadowbox)
keepspaces=true, % % keeps spaces in text, useful for keeping indentation of code
literate={~}{$\sim$}{1}, % symbol properly display via latex
numbers=none, % where to put the line-numbers; possible values are (none, left, right)
numbersep=10pt, % how far the line-numbers are from the code
showspaces=false,
showstringspaces=false,
stepnumber=1, % the step between two line-numbers. If it's 1, each line will be numbered
tabsize=1,
xleftmargin=0cm,
emph={anova,apply,class,coef,colnames,colNames,colSums,dim,dcast,for,ggplot,head,if,ifelse,is.na,lapply,list.files,library,logLik,melt,plot,require,rowSums,sapply,setcolorder,setkey,str,summary,tapply},
aboveskip = \medskipamount, % define the space above displayed listings.
belowskip = \medskipamount, % define the space above displayed listings.
lineskip = 0pt} % specifies additional space between lines in listings
\lstset{style=code-small}
%%%% packages %%%%%

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{textcomp}
\usepackage{color}
\usepackage{graphicx}
\usepackage{grffile}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage{longtable}
\usepackage{multirow}
\usepackage{multicol}
\usepackage{changes}
\usepackage{pdflscape}
\usepackage{geometry}
\usepackage[normalem]{ulem}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{dsfont}
\usepackage{array}
\usepackage{ifthen}
\usepackage{hyperref}
\usepackage{natbib}
\RequirePackage{setspace} % to modify the space between lines - incompatible with footnote in beamer
\renewcommand{\baselinestretch}{1.1}
\geometry{top=1cm}
\usepackage{titlesec}
\usepackage{etoolbox}
\makeatletter
\patchcmd{\ttlh@hang}{\parindent\z@}{\parindent\z@\leavevmode}{}{}
\patchcmd{\ttlh@hang}{\noindent}{}{}{}
\makeatother
\RequirePackage{colortbl} % arrayrulecolor to mix colors
\definecolor{myorange}{rgb}{1,0.2,0}
\definecolor{mypurple}{rgb}{0.7,0,8}
\definecolor{mycyan}{rgb}{0,0.6,0.6}
\newcommand{\lightblue}{blue!50!white}
\newcommand{\darkblue}{blue!80!black}
\newcommand{\darkgreen}{green!50!black}
\newcommand{\darkred}{red!50!black}
\definecolor{gray}{gray}{0.5}
\hypersetup{
citecolor=[rgb]{0,0.5,0},
urlcolor=[rgb]{0,0,0.5},
linkcolor=[rgb]{0,0,0.5},
}
\newenvironment{comment}{\small \color{gray}\fontfamily{lmtt}\selectfont}{\par}
\newenvironment{activity}{\color{orange}\fontfamily{qzc}\selectfont}{\par}
\RequirePackage{pifont}
\RequirePackage{relsize}
\newcommand{\Cross}{{\raisebox{-0.5ex}%
{\relsize{1.5}\ding{56}}}\hspace{1pt} }
\newcommand{\Valid}{{\raisebox{-0.5ex}%
{\relsize{1.5}\ding{52}}}\hspace{1pt} }
\newcommand{\CrossR}{ \textcolor{red}{\Cross} }
\newcommand{\ValidV}{ \textcolor{green}{\Valid} }
\usepackage{stackengine}
\usepackage{scalerel}
\newcommand\Warning[1][3ex]{%
\renewcommand\stacktype{L}%
\scaleto{\stackon[1.3pt]{\color{red}$\triangle$}{\tiny\bfseries !}}{#1}%
\xspace
}
\newcommand\Rlogo{\textbf{\textsf{R}}\xspace} %
\RequirePackage{fancyvrb}
\DefineVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\small,formatcom = {\color[rgb]{0.5,0,0}}}
\RequirePackage{enumitem} % better than enumerate
\RequirePackage{epstopdf} % to be able to convert .eps to .pdf image files
\RequirePackage{capt-of} %
\RequirePackage{caption} % newlines in graphics
\RequirePackage{tikz-cd} % graph
\RequirePackage{booktabs} % for nice lines in table (e.g. toprule, bottomrule, midrule, cmidrule)
\RequirePackage{amsmath}
\RequirePackage{algorithm}
\RequirePackage[noend]{algpseudocode}
\RequirePackage{dsfont}
\RequirePackage{amsmath,stmaryrd,graphicx}
\RequirePackage{prodint} % product integral symbol (\PRODI)
\usepackage{ifthen}
\usepackage{xifthen}
\usepackage{xargs}
\usepackage{xspace}
\newcommand\defOperator[7]{%
\ifthenelse{\isempty{#2}}{
\ifthenelse{\isempty{#1}}{#7{#3}#4}{#7{#3}#4 \left#5 #1 \right#6}
}{
\ifthenelse{\isempty{#1}}{#7{#3}#4_{#2}}{#7{#3}#4_{#1}\left#5 #2 \right#6}
}
}
\newcommand\defUOperator[5]{%
\ifthenelse{\isempty{#1}}{
#5\left#3 #2 \right#4
}{
\ifthenelse{\isempty{#2}}{\underset{#1}{\operatornamewithlimits{#5}}}{
\underset{#1}{\operatornamewithlimits{#5}}\left#3 #2 \right#4}
}
}
\newcommand{\defBoldVar}[2]{
\ifthenelse{\equal{#2}{T}}{\boldsymbol{#1}}{\mathbf{#1}}
}
\newcommandx\Esp[2][1=,2=]{\defOperator{#1}{#2}{E}{}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Prob[2][1=,2=]{\defOperator{#1}{#2}{P}{}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Qrob[2][1=,2=]{\defOperator{#1}{#2}{Q}{}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Var[2][1=,2=]{\defOperator{#1}{#2}{V}{ar}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Cov[2][1=,2=]{\defOperator{#1}{#2}{C}{ov}{\lbrack}{\rbrack}{\mathbb}}
\newcommandx\Binom[2][1=,2=]{\defOperator{#1}{#2}{B}{}{(}{)}{\mathcal}}
\newcommandx\Gaus[2][1=,2=]{\defOperator{#1}{#2}{N}{}{(}{)}{\mathcal}}
\newcommandx\Wishart[2][1=,2=]{\defOperator{#1}{#2}{W}{ishart}{(}{)}{\mathcal}}
\newcommandx\Likelihood[2][1=,2=]{\defOperator{#1}{#2}{L}{}{(}{)}{\mathcal}}
\newcommandx\logLikelihood[2][1=,2=]{\defOperator{#1}{#2}{\ell}{}{(}{)}{}}
\newcommandx\Information[2][1=,2=]{\defOperator{#1}{#2}{I}{}{(}{)}{\mathcal}}
\newcommandx\Score[2][1=,2=]{\defOperator{#1}{#2}{S}{}{(}{)}{\mathcal}}
\newcommandx\Vois[2][1=,2=]{\defOperator{#1}{#2}{V}{}{(}{)}{\mathcal}}
\newcommandx\IF[2][1=,2=]{\defOperator{#1}{#2}{IF}{}{(}{)}{\mathcal}}
\newcommandx\Ind[1][1=]{\defOperator{}{#1}{1}{}{(}{)}{\mathds}}
\newcommandx\Max[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{min}}
\newcommandx\Min[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{max}}
\newcommandx\argMax[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{argmax}}
\newcommandx\argMin[2][1=,2=]{\defUOperator{#1}{#2}{(}{)}{argmin}}
\newcommandx\cvD[2][1=D,2=n \rightarrow \infty]{\xrightarrow[#2]{#1}}
\newcommandx\Hypothesis[2][1=,2=]{
\ifthenelse{\isempty{#1}}{
\mathcal{H}
}{
\ifthenelse{\isempty{#2}}{
\mathcal{H}_{#1}
}{
\mathcal{H}^{(#2)}_{#1}
}
}
}
\newcommandx\dpartial[4][1=,2=,3=,4=\partial]{
\ifthenelse{\isempty{#3}}{
\frac{#4 #1}{#4 #2}
}{
\left.\frac{#4 #1}{#4 #2}\right\rvert_{#3}
}
}
\newcommandx\dTpartial[3][1=,2=,3=]{\dpartial[#1][#2][#3][d]}
\newcommandx\ddpartial[3][1=,2=,3=]{
\ifthenelse{\isempty{#3}}{
\frac{\partial^{2} #1}{\partial #2^2}
}{
\frac{\partial^2 #1}{\partial #2\partial #3}
}
}
\newcommand\Real{\mathbb{R}}
\newcommand\Rational{\mathbb{Q}}
\newcommand\Natural{\mathbb{N}}
\newcommand\trans[1]{{#1}^\intercal}%\newcommand\trans[1]{{\vphantom{#1}}^\top{#1}}
\newcommand{\independent}{\mathrel{\text{\scalebox{1.5}{$\perp\mkern-10mu\perp$}}}}
\newcommand\half{\frac{1}{2}}
\newcommand\normMax[1]{\left|\left|#1\right|\right|_{max}}
\newcommand\normTwo[1]{\left|\left|#1\right|\right|_{2}}
\newcommand\Veta{\boldsymbol{\eta}}
\newcommand\VX{\mathbf{X}}
\author{Brice Ozenne}
\date{\today}
\title{Introduction to Laplace approximation with examples in R}
\hypersetup{
 colorlinks=true,
 pdfauthor={Brice Ozenne},
 pdftitle={Introduction to Laplace approximation with examples in R},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={Emacs 27.0.50 (Org mode 9.0.4)},
 pdflang={English}
 }
\begin{document}

\maketitle
Ressource: \url{http://www.imm.dtu.dk/\~hmad/GLM/Slides\_2012/week11/lect11.pdf}


\section{Principle}
\label{sec:orgde8c156}

Consider a positive function \(F\) of two variables \(x\) and \(y\). We would
like to marginalize \(F\) over \(x\):
\begin{align*}
F(y) &= \int_x F(x,y) dx \\
&= \int_x \exp( f(x,y) ) dx
\end{align*}
where \(f(x,y)=log(F(x,y))\) Assume that \(f(x,y)\) admits a global
maximum (with respect to x) at \(\hat{x}\). Then, under some
regularity assumption, we can use a taylor expansion to obtain:
\begin{align*}
F(y) &= \int_x F(x,y) dx \\
&= \int_x \exp\left( f(\hat{x},y) + \frac{(\hat{x}-x)^2}{2} f''(\hat{x},y) + o_p\left((\hat{x}-x)^2\right) \right) dx \\
&= F(\hat{x},y)  \int_x \exp\left( \frac{(\hat{x}-x)^2}{2} f''(\hat{x},y)\right)  dx + o_p\left((\hat{x}-x)^2\right) \\
&= F(\hat{x},y)  \sqrt{\frac{2\pi}{|f''(\hat{x},y)|}} + o_p\left((\hat{x}-x)^2\right) \\
\end{align*}

\clearpage

\section{Application}
\label{sec:orgfa2b09f}

\subsection{Linear mixed model}
\label{sec:orgaf1f044}

\subsubsection{Formula}
\label{sec:orga33e853}

Consider the following linear mixed model:
\begin{align*}
Y_{ij} = X_{ij} \beta + u_i + \varepsilon_{ij} 
\end{align*}
where \(\varepsilon_{ij} \sim \Gaus[0,\sigma^2]\) and \(u_i \sim
\Gaus[0,\tau]\). Then denoting \(\theta = (\beta,\sigma^2,\tau)\):
\begin{align*}
F(u_i,\theta) &= \left( \prod_{j=1}^m \frac{1}{(2\pi \sigma^2)^{1/2}} \exp\left(-\frac{1}{2\sigma^2} (Y_{ij}-X_{ij}\beta-u_i)^2 \right) \right)
 \frac{1}{(2\pi \tau)^{1/2}} \exp\left(-\frac{u_i^2}{2\tau} \right) \\
f(u_i,\theta) &= - \sum_{j=1}^m \frac{1}{2} \log(2\pi \sigma^2) -\frac{1}{2\sigma^2} (Y_{ij}-X_{ij}\beta-u_i)^2 
- \frac{1}{2} \log(2\pi \tau) -\frac{u_i^2}{2\tau} \\
&=  - \frac{m}{2} \log(2\pi \sigma^2) - \frac{1}{2} \log(2\pi \tau) 
- \frac{1}{2\sigma^2} \sum_{j=1}^m (Y_{ij}-X_{ij}\beta-u_i)^2 
- \frac{1}{2\tau} u_i^2 
\end{align*}
So
\begin{align*}
f''(u_i,\theta) = - \frac{m}{\sigma^2} - \frac{1}{\tau} 
\end{align*}
and we note that a second order Taylor expansion is enough since
\(f'''(u_i,\theta)=0\). Therefore we get for the log-likelihood:
\begin{align*}
f(\theta) =
& - \frac{m}{2} \log(2\pi \sigma^2) - \frac{1}{2\sigma^2} \sum_{j=1}^m (Y_{ij}-X_{ij}\beta-\hat{u}_i)^2  \\
& - \frac{1}{2\tau} \hat{u}_i^2 - \frac{1}{2} \log(2\pi \tau) \\
& + \frac{1}{2} \log\left(\frac{2 \pi}{m\sigma^{-2} + \tau^{-1}}\right) 
\end{align*}

\clearpage 

\subsubsection{R code}
\label{sec:orgcfc9ade}

Load packages:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
library(lava)
library(lavaSearch2)
library(mvtnorm)
library(nlme)
library(data.table)
\end{lstlisting}

Simulate data
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
mSim <- lvm(c(Y1,Y2,Y3,Y4,Y5)~tau,
	 tau ~ X1+X2)
latent(mSim) <- ~tau
transform(mSim, id ~ tau) <- function(x){1:NROW(x)}

m <- lvm(c(Y1,Y2,Y3,Y4,Y5)~1*tau,
	 tau ~ 0+X1+X2)
variance(m, ~Y1) <- "sigma"
variance(m, ~Y2) <- "sigma"
variance(m, ~Y3) <- "sigma"
variance(m, ~Y4) <- "sigma"
variance(m, ~Y5) <- "sigma"

set.seed(10)
n <- 100
dW <- as.data.table(lava::sim(mSim, n = n, latent = FALSE))
dL <- melt(dW, id.vars = c("id","X1","X2"), variable.name = "time", value.name = "Y")
\end{lstlisting}

Fit linear mixed effect model:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
e.lava <- estimate(m, dW)
e.nlme <- lme(Y ~ -1 + X1 + X2 + time,
	      random = ~ 1|id, data = dL, method = "ML")

logLik(e.lava)
logLik(e.nlme)
\end{lstlisting}

\begin{verbatim}
'log Lik.' -810.9451 (df=9)
'log Lik.' -810.9451 (df=9)
\end{verbatim}

\clearpage

Compute marginal likelihood:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
logLik_marginal <- function(model, data = NULL, param = NULL){
    ## initialize
    if(is.null(data)){
	data <- as.data.frame(model.frame(model))
    }
    if(is.null(param)){
	param <- coef(model)
    }

    ## find sufficient statisitcs
    Sigma <- getVarCov2(model, data = data, param = param)
    epsilon <- residuals(model, newdata = data, p = param)
    m <- NCOL(epsilon)

    ## compute log likelihood
    out <- dmvnorm(x = epsilon, mean = rep(0, m), sigma = Sigma, log = TRUE)
    ## n <- NROW(epsilon)
    ## out <- -(n*m/2)*log(2*pi) - (n/2)*log(det(Sigma)) - 0.5*sum((epsilon %*% solve(Sigma)) * epsilon)
    return(out)
}
sum(logLik_marginal(e.lava))
\end{lstlisting}

\begin{verbatim}
[1] -810.9451
\end{verbatim}

\clearpage

Compute conditional likelihood:
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
logLik_conditional <- function(model, Zb = NULL, 
			       data = NULL, param = NULL){

    ## initialize
    if(is.null(data)){
	data <- as.data.frame(model.frame(model))
    }
    if(is.null(param)){
	param <- coef(model)
    }

    ## identify variance of the random effect
    df.type <- coefType(model, as.lava=FALSE)
    df.type <- df.type[!is.na(df.type$detail),]
    tau <- param[df.type[df.type$detail=="Psi_var","param"]]

    ## estimate sufficient statistics
    Sigma.m <- getVarCov2(model, data = data, param = param)
    Sigma.c <- Sigma.m - tau
    YmXB <- residuals(model, newdata = data, p = param)

    ## compute random effects
    m <- NCOL(YmXB)
    if(is.null(Zb)){
	Z <- matrix(1, nrow = 1, ncol = m)
	Omega <- solve(Z %*% solve(Sigma.c) %*% t(Z) + 1/tau) %*% Z %*% solve(Sigma.c)
	Zb <- as.double(Omega %*% t(YmXB)) ## cbind(ranef(e.nlme),Zb)
    }
    epsilon <- YmXB - Zb

    out1 <- dmvnorm(x = epsilon, mean = rep(0, m), sigma = Sigma.c, log = TRUE)
    out2 <- dnorm(x = Zb, mean = 0, sd = sqrt(tau), log = TRUE)
    return(out1 + out2)
}
\end{lstlisting}

Laplace approximation
\lstset{language=r,label= ,caption= ,captionpos=b,numbers=none}
\begin{lstlisting}
d2.f <- 5/coef(e.lava)["Y1~~Y1"]+1/coef(e.lava)["tau~~tau"]
sum(logLik_conditional(e.lava) + (1/2)*log(2*pi/d2.f))
\end{lstlisting}

\begin{verbatim}
[1] -810.9451
\end{verbatim}

\clearpage

\subsection{General gaussian model}
\label{sec:orgc6ea907}

Consider the following gaussian mixed model:
\begin{align*}
Y_{i} \sim \Gaus[\mu(X_{i}, \beta,u_i),\Sigma]
\end{align*}
Denoting by \(m\) the number of observations per individual we have:
\begin{align*}
f(u_i,\theta) &= - \frac{1}{2} \log\left((2\pi)^m |\Sigma|\right) - \frac{1}{2} (Y_{i}-\mu(X_{i},\beta,u_i)) \Sigma^{-1} \trans{(Y_{ij}-\mu(X_{i},\beta,u_i))}
- \frac{1}{2} \log(2\pi \tau) -\frac{u_i^2}{2\tau} \\
&\propto  - \frac{1}{2} \log|\Sigma| - \frac{1}{2} \log(\tau) 
- \frac{1}{2} (Y_{i}-\mu(X_{i},\beta,u_i)) \Sigma^{-1} \trans{(Y_{ij}-\mu(X_{i},\beta,u_i))}
- \frac{1}{2\tau} u_i^2 
\end{align*}
Since 
\begin{align*}
f''(u_i,\theta) = - \mu'(X_{i},\beta,u_i) \Sigma^{-1} \trans{\mu'(X_{i},\beta,u_i)} - \frac{1}{\tau}
\end{align*}
we get:
\begin{align*}
f(\theta) =
& - \frac{1}{2} \log\left((2\pi)^m |\Sigma|\right) - \frac{1}{2} (Y_{i}-\mu(X_{i},\beta,u_i)) \Sigma^{-1} \trans{(Y_{ij}-\mu(X_{i},\beta,u_i))} \\
& - \frac{1}{2} \log(2\pi \tau) -\frac{u_i^2}{2\tau} \\
& + \frac{1}{2} \log\left(\frac{2 \pi}{\mu'(X_{i},\beta,u_i) \Sigma^{-1} \trans{\mu'(X_{i},\beta,u_i)} + \tau^{-1}}\right) 
\end{align*}
\end{document}