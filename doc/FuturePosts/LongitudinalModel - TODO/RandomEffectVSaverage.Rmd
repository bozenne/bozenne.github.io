---
title: "longitudinal analysis - how to average"
output:
  pdf_document:
    fig_caption: yes
    keep_tex: no
    number_sections: yes
    toc: no
fontsize: 12pt
---

# Rational (same variance over time)

Consider a dataset with repeated measurement over time for each individual. Suppose we are interested by the effect of a variable that is at the individual level (e.g. male vs. female). For instance we have: \newline
Level 0 : Gender \newline
Level 1 : Individual \newline
Level 2 : Time

Then, under some assumptions (linearity assumptions, balanced design), we can average over level 2 and perform the analysis on the averaged data.

\clearpage

## Simulation

### Settings 

```{r, message=FALSE}
require(ggplot2)
require(lme4) ; require(nlme)
require(data.table)

set.seed(9)

n.times <- 20
n.patients <- c(20,30)

diff_group <- 1.5
sdRF <- 2
sdNoise <- 1.5

mean1 <- seq(1,2, length.out = n.times) 
```

### Generation of the dataset

```{r}
mean2 <- diff_group + mean1
randomEffect <- as.vector(sapply(rnorm(sum(n.patients), sd = sdRF),
                                 rep, n.times))
Id <- as.vector(sapply(1:sum(n.patients),
                rep, n.times))

Y <- c(rnorm(n.patients[1]*n.times, mean = mean1, sd = sdNoise),
       rnorm(n.patients[2]*n.times, mean = mean2, sd = sdNoise))

dt.data <- data.table(Id = as.character(Id), Y = Y + randomEffect,
                      time = 1:n.times,
                      type = c(rep("0", n.times*n.patients[1]), 
                               rep("1", n.times*n.patients[2])) )

ggplot(dt.data, aes(y = Y, x = time, group = Id, col = type)) + geom_line()
```

\clearpage

## Analysis

### random effect model

```{r}
lme.Simul <- lme(Y ~ type + time, 
                 data = dt.data,
                 random = ~1 | Id)
summary(lme.Simul)
anova(lme.Simul, type = "marginal")
```

Note that $n.times*coef(lme.Simul)[1,"time"] =$ `r n.times*coef(lme.Simul)[1,"time"]` is close to $diff(range(mean1)) =$ `r diff(range(mean1))`, as fixed by the simulation.

### Average over time (level 2)
```{r}
dt.data.Id <- dt.data[,.(Y = mean(Y)), by = c("type","Id")]
setkeyv(dt.data.Id, c("type","Id"))

ggplot(dt.data.Id, 
       aes(y = Y, x = as.numeric(Id), group = type, col = type)) + geom_line()

aov.Id <- lm(Y ~ type, data = dt.data.Id)
summary(aov.Id)
anova(aov.Id)
```
CORRECT: same results as lme

### Average over individual
```{r}
dt.data.time <- dt.data[,.(Y = mean(Y)), by = c("type","time")]
setkeyv(dt.data.time, c("type","time"))

ggplot(dt.data.time, 
       aes(y = Y, x = time, group = type, col = type)) + geom_line()

aov.time <- lm(Y ~ type, data = dt.data.time)
summary(aov.time)
anova(aov.time)

t.test(dt.data.time[type==0,Y],  dt.data.time[type==1,Y])
summary(lm(Y ~ type, data = dt.data.time))
t.test(dt.data.time[type==0,Y],  dt.data.time[type==1,Y],
       paired = TRUE)
```
INCORRECT: underestimation of the variability


# Rational (different variance over time)



## Simulation


```{r, message=FALSE}
## same variance
n <- 1e3

Mcorr <- diag(rep(1,3))^2
Mcorr[Mcorr==0] <- 0.5
M <- rbind( cbind(mvtnorm::rmvnorm(n, mean = rep(1,3), sigma = Mcorr), Gender = 0),
            cbind(mvtnorm::rmvnorm(n, mean = rep(2,3), sigma = Mcorr), Gender = 1)
)
dt <- as.data.table(M)
dt[, Id := 1:.N]

dt2 <- copy(dt)
dt2[, Y := (V1 + V2 + V3)/3]


dtL <- melt(dt, id.vars = c("Id","Gender"))

m.gls <- gls(value ~ Gender, data = dtL, 
             correlation = corCompSymm(form=~1|Id),
             weights = varIdent(form=~1|variable))

m.lme <- lme(value ~ Gender, data = dtL, 
             random = ~1|Id,
             weights = varIdent(form=~1|variable))

m.lmer <- lmer(value ~ Gender + (1|Id), data = dtL)

getVarCov(m.gls)
getVarCov(m.lme)

summary(m.gls)$tTable
summary(m.lme)$tTable
summary(m.lmer)$coefficients

summary(lm(Y~Gender, data = dt2))

## heterogeneous variance
n <- 1e3

Mcorr <- diag(1:3)^2
Mcorr[Mcorr==0] <- 0
M <- rbind( cbind(mvtnorm::rmvnorm(n, mean = rep(1,3), sigma = Mcorr), Gender = 0),
            cbind(mvtnorm::rmvnorm(n, mean = rep(2,3), sigma = Mcorr), Gender = 1)
)
dt <- as.data.table(M)
dt[, Id := 1:.N]

dt2 <- copy(dt)
dt2[, V1s := scale(V1)]
dt2[, V2s := scale(V2)]
dt2[, V3s := scale(V3)]

dt2[, Y := (V1 + V2 + V3)/3]
dt2[, Ys := (V1s + V2s + V3s)/3]

dtL <- melt(dt, id.vars = c("Id","Gender"))

m.gls <- gls(value ~ Gender, data = dtL, 
             correlation = corCompSymm(form=~1|Id),
             weights = varIdent(form=~1|variable))

getVarCov(m.gls)

m.lme <- lme(value ~ Gender, data = dtL, 
             random = ~1|Id,
             correlation = corCompSymm(form=~1|Id),
             weights = varIdent(form=~1|variable))


m.lmer <- lmer(value ~ Gender + (0+variable|Id), data = dtL)

summary(m.gls)$tTable
summary(m.lme)$tTable
summary(m.lmer)$coefficients

m.lvm <- lvm(list(V1~eta,V2~eta,V3~eta,eta~Gender))
latent(m.lvm) <- ~eta
plot(m.lvm)
system.time(
  res <- estimate(m.lvm, data = dt)
)

### big model
n <- 100
p <- 10

Mcorr <- diag(rep(1,p))^2
Mcorr[Mcorr==0] <- 0.5
M <- rbind( cbind(mvtnorm::rmvnorm(n, mean = rep(1,p), sigma = Mcorr), Gender = 0),
            cbind(mvtnorm::rmvnorm(n, mean = rep(2,p), sigma = Mcorr), Gender = 1)
)
dt <- as.data.table(M)

ls.txt <- as.list(paste("V",1:p,"~eta",sep=""))
ls.formula <- lapply(ls.txt, as.formula)
m.lvm <- lvm(ls.formula)
regression(m.lvm) <- eta ~ Gender
latent(m.lvm) <- ~eta
plot(m.lvm)
system.time(
  res <- estimate(m.lvm, data = dt)
)
summary(res)

dtRes <- data.table(res = residuals(res)[,1],
                    age = residuals(res)[,2])

ggplot(dtRes, aes(x = age, y = res)) + geom_point() + geom_smooth()

```
